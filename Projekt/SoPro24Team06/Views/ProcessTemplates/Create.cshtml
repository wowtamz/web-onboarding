@model SoPro24Team06.ViewModels.ProcessTemplateViewModel

<form asp-controller="ProcessTemplate" asp-action="Create" method="post">
  <fieldset style="margin-top: 8px">
    <legend>Prozesstitel</legend>
    <input class="form-control" type="text" asp-for="Title" />
    <span asp-validation-for="Title" class="text-danger"></span>
  </fieldset>
  <fieldset style="margin-top: 8px">
    <legend>Vertragstyp</legend>
    <button class="btn btn-primary" type="button" onclick="showModal('modal-contract')"
      style="margin-top: 0px; margin-bottom: 0px">
      Vertragstyp
    </button>
    <span asp-validation-for="ContractOfRefWorker" class="text-danger"></span>
  </fieldset>
  <fieldset style="margin-top: 8px">
    <legend>Rolle</legend>
    <button class="btn btn-primary" type="button" onclick="showModal('modal-role')"
      style="margin-top: 0px; margin-bottom: 0px; margin-right: 12px">
      Rolle
    </button>
    <span asp-validation-for="RolesWithAccess" class="text-danger"></span>
  </fieldset>
  <fieldset style="margin-top: 8px">
    <legend>Abteilung</legend>
    <button class="btn btn-primary" type="button" onclick="showModal('modal-department')"
      style="margin-top: 0px; margin-bottom: 0px">
      Abteilung
    </button>
    <span asp-validation-for="DepartmentOfRefWorker" class="text-danger"></span>
  </fieldset>
  <fieldset style="margin-top: 8px">
    <legend>Beschreibung</legend>
    <textarea class="form-control" asp-for="Description"></textarea>
    <span asp-validation-for="Description" class="text-danger"></span>
  </fieldset>
  <fieldset style="margin-top: 8px">
    <legend>
      Aufgaben
      <button class="btn btn-primary" type="button" onclick="showModal('modal-task')" style="margin-left: 16px">
        Aufgaben hinzufügen
      </button>
    </legend>
    <div class="table-responsive">
      <table class="table" id="selectedAssignmentsTable">
        <thead>
          <tr>
            <th>Titel</th>
            <th>Anleitung</th>
            <th>Aufgabenzuständiger</th>
            <th>Vertragsart</th>
            <th>Abteilung</th>
            <th>Aktionen</th>
          </tr>
        </thead>
        <tbody>
          @if (Model.SelectedAssignmentTemplates.Count == 0)
          {
            <tr>
              <td colspan="6">Keine Aufgaben vorhanden</td>
            </tr>
          }
          else
          {
            @foreach (var assignment in Model.SelectedAssignmentTemplates)
            {
              <tr>
                <td>@assignment.Title</td>
                <td>@assignment.Instructions</td>
                <td>@assignment.AssigneeType</td>
                <td>
                  <button type="button" class="btn btn-danger" onclick="removeTask(@assignment.Id)">Entfernen</button>
                </td>
              </tr>
            }
          }
        </tbody>
      </table>
    </div>
  </fieldset>
  <button class="btn btn-primary" type="submit" style="margin-top: 12px">
    Erstellen
  </button>
</form>

<partial name="_AssignmentTemplateModal" model="Model" />
<partial name="_RoleModal" model="Model" />
<partial name="_DepartmentModal" model="Model" />

<script>
  function showModal(modalId) {
    // Load modal content via AJAX or just display the modal if content is pre-loaded
    $('#' + modalId).modal('show');
  }

  function addAssignment(button) {
    var taskId = button.getAttribute('data-id');
    var title = button.getAttribute('data-title');
    // Assuming more data attributes if needed, for example:
    // var description = button.getAttribute('data-description');

    $.ajax({
      url: '@Url.Action("AddAssignment", "ProcessTemplate")',  // Ensure correct URL
      type: 'POST',
      data: { id: taskId },
      success: function (result) {
        // Assuming result contains the HTML to append
        $('#selectedAssignmentsTable').append(result);
        alert('Aufgabe hinzugefügt: ' + title);
      },
      error: function (xhr, status, error) {
        console.error("Error adding assignment: " + error);
      }
    });
  }


  function removeTask(id) {
    $.ajax({
      url: '@Url.Action("RemoveAssignment", "ProcessTemplate")',
      type: 'POST',
      data: { id: id },
      success: function () {
        $('tr[data-id="' + id + '"]').remove();
      },
      error: function (xhr, status, error) {
        console.error("Error removing assignment: " + error);
      }
    });
  }
</script>

@section Scripts {
  @{
    await Html.RenderPartialAsync("_ValidationScriptsPartial");
  }
}
